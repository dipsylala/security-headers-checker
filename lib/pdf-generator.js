/**
 * Enhanced PDF Generator with Unicode Support using Puppeteer
 * Generates professional security analysis reports from HTML templates
 */

const puppeteer = require('puppeteer');
const path = require('path');
const fs = require('fs').promises;

/**
 * Generate PDF report using Puppeteer (server-side)
 * @param {Object} analysisResults - Complete analysis results
 * @param {string} filename - Output filename (without extension)
 * @returns {Promise<Buffer>} PDF buffer
 */
async function generatePDFReport(analysisResults, filename = 'security-report') {
    let browser;
    
    try {
        console.log('üöÄ Starting PDF generation...');
        
        // Launch browser
        browser = await puppeteer.launch({
            headless: 'new',
            args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
        });
        
        console.log('‚úÖ Browser launched');
        
        const page = await browser.newPage();
        
        // Set viewport for consistent rendering
        await page.setViewport({ width: 1200, height: 800 });
        
        console.log('üé® Generating HTML content...');
        
        // Generate comprehensive HTML content with all details
        const htmlContent = generateComprehensiveReportHTML(analysisResults);
        
        console.log('üìÑ Setting page content...');
        
        // Set HTML content
        await page.setContent(htmlContent, { 
            waitUntil: 'networkidle0',
            timeout: 30000 
        });
        
        console.log('üéØ Generating PDF...');
        
        // Generate PDF with professional settings
        const pdfBuffer = await page.pdf({
            format: 'A4',
            printBackground: true,
            margin: {
                top: '20mm',
                right: '15mm',
                bottom: '20mm',
                left: '15mm'
            }
        });
        
        console.log(`‚úÖ PDF generated: ${pdfBuffer.length} bytes`);
        
        return pdfBuffer;
        
    } catch (error) {
        console.error('PDF generation error:', error);
        throw new Error(`Failed to generate PDF: ${error.message}`);
    } finally {
        if (browser) {
            await browser.close();
        }
    }
}

/**
 * Generate simple HTML content for testing
 * @param {Object} results - Analysis results
 * @returns {string} HTML content
 */
function generateSimpleReportHTML(results) {
    return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Analysis Report</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            color: #333;
        }
        h1 { color: #2980b9; }
        h2 { color: #34495e; margin-top: 30px; }
        .score { font-size: 24px; font-weight: bold; color: #e74c3c; }
        .summary { background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0; }
        .section { margin: 20px 0; }
        .pass { color: #27ae60; }
        .fail { color: #e74c3c; }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è WebCheck Security Analysis Report</h1>
    
    <div class="summary">
        <h2>üìä Summary</h2>
        <p><strong>URL:</strong> ${results.url || 'N/A'}</p>
        <p><strong>Score:</strong> <span class="score">${results.score || 0}/100</span></p>
        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
    </div>
    
    <div class="section">
        <h2>üîí SSL Certificate</h2>
        <p>Status: <span class="${results.ssl?.valid ? 'pass' : 'fail'}">${results.ssl?.valid ? 'Valid' : 'Invalid'}</span></p>
        ${results.ssl?.issuer ? `<p><strong>Issuer:</strong> ${results.ssl.issuer}</p>` : ''}
        ${results.ssl?.grade ? `<p><strong>Grade:</strong> ${results.ssl.grade}</p>` : ''}
    </div>
    
    <div class="section">
        <h2>üõ°Ô∏è Security Headers</h2>
        ${results.headers ? `
            <p>Total Headers Analyzed: ${results.headers.length}</p>
            <p>Present: ${results.headers.filter(h => h.present).length}</p>
            <p>Missing: ${results.headers.filter(h => !h.present).length}</p>
        ` : '<p>No header analysis available</p>'}
    </div>
    
    <div class="section">
        <h2>üîç Additional Checks</h2>
        ${results.additional ? `
            <p>Total Checks: ${results.additional.length}</p>
            <p>Passed: ${results.additional.filter(c => c.status === 'pass').length}</p>
            <p>Failed: ${results.additional.filter(c => c.status === 'fail').length}</p>
        ` : '<p>No additional checks available</p>'}
    </div>
    
    <footer style="margin-top: 50px; text-align: center; color: #666; border-top: 1px solid #eee; padding-top: 20px;">
        <p>Generated by WebCheck Validator ‚Ä¢ ${new Date().toLocaleDateString()}</p>
    </footer>
</body>
</html>`;
}

/**
 * Generate HTML content for the PDF report (Full Version)
 * @param {Object} results - Analysis results
 * @returns {string} HTML content
 */
function generateReportHTML(results) {
    return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Analysis Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: white;
        }
        
        .container {
            max-width: 210mm;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            color: white;
            position: relative;
        }
        
        .score-excellent { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .score-good { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .score-poor { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        
        .section {
            margin: 40px 0;
            page-break-inside: avoid;
        }
        
        .section-header {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-content {
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            padding: 20px;
            border-radius: 0 0 8px 8px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #ddd;
        }
        
        .status-pass {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        .status-fail {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .status-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .status-icon {
            font-size: 1.2em;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .headers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .header-category {
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .category-title {
            background: #495057;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-stats {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .header-list {
            padding: 15px;
        }
        
        .header-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .header-item:last-child {
            border-bottom: none;
        }
        
        .recommendation-box {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .recommendation-high {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .recommendation-medium {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .recommendation-low {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .ssl-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .cert-chain {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .cert-level {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        
        .progress-warning { background: linear-gradient(90deg, #ffc107, #fd7e14); }
        .progress-danger { background: linear-gradient(90deg, #dc3545, #e74c3c); }
        
        /* Enhanced SSL Analysis Styles */
        .ssl-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .grade-strong { color: #28a745; font-weight: bold; }
        .grade-good { color: #20c997; font-weight: bold; }
        .grade-weak { color: #fd7e14; font-weight: bold; }
        .grade-poor { color: #dc3545; font-weight: bold; }
        .grade-critical { color: #721c24; font-weight: bold; }
        
        .cipher-suite-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .cipher-suite-table th,
        .cipher-suite-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
            font-size: 0.85em;
        }
        
        .cipher-suite-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .cipher-name {
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            word-break: break-all;
        }
        
        .security-breakdown {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #6c757d;
        }
        
        .vulnerability-card {
            border-left: 4px solid #dc3545;
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .vulnerability-high { border-left-color: #dc3545; }
        .vulnerability-medium { border-left-color: #fd7e14; }
        .vulnerability-low { border-left-color: #ffc107; }
        
        @media print {
            .container { padding: 0; }
            .section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        ${generateHeaderSection(results)}
        ${generateSummarySection(results)}
        ${generateSSLSection(results)}
        ${generateHeadersSection(results)}
        ${generateSecurityChecksSection(results)}
        ${generateRecommendationsSection(results)}
    </div>
</body>
</html>`;
}

function generateHeaderSection(results) {
    return `
        <div class="header">
            <h1>üõ°Ô∏è Security Analysis Report</h1>
            <p>Comprehensive Web Security Assessment</p>
            <div style="margin-top: 20px; font-size: 1em;">
                <strong>${results.url || 'Unknown URL'}</strong><br>
                Generated: ${new Date(results.timestamp || Date.now()).toLocaleString()}
            </div>
        </div>
    `;
}

function generateSummarySection(results) {
    const score = results.score || 0;
    let scoreClass = 'score-poor';
    let scoreText = 'Needs Improvement';
    
    if (score >= 80) {
        scoreClass = 'score-excellent';
        scoreText = 'Excellent';
    } else if (score >= 60) {
        scoreClass = 'score-good';
        scoreText = 'Good';
    }
    
    return `
        <div class="section">
            <div class="section-header">
                üìä Security Score Overview
            </div>
            <div class="section-content">
                <div style="text-align: center;">
                    <div class="score-circle ${scoreClass}">
                        ${score}%
                    </div>
                    <h3>${scoreText} Security Posture</h3>
                    <p>Overall security score: ${score}/100</p>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <h4>üîí SSL/TLS Status</h4>
                        <p><strong>Status:</strong> ${results.ssl?.valid ? '‚úÖ Valid' : '‚ùå Invalid'}</p>
                        <p><strong>Grade:</strong> ${results.ssl?.grade || 'N/A'}</p>
                    </div>
                    <div class="summary-card">
                        <h4>üõ°Ô∏è Security Headers</h4>
                        <p><strong>Present:</strong> ${results.headers?.filter(h => h.present).length || 0}</p>
                        <p><strong>Missing:</strong> ${results.headers?.filter(h => !h.present).length || 0}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generateSSLSection(results) {
    if (!results.ssl) return '';
    
    // Extract detailed SSL data
    const sslData = results.ssl;
    const detailedData = results.details?.detailedSsl || {};
    const cipherSuiteData = detailedData.cipherSuites || {};
    
    let sslHTML = `
        <div class="section">
            <div class="section-header">
                üîê Comprehensive SSL/TLS Certificate Analysis
            </div>
            <div class="section-content">
                ${generateBasicCertificateInfo(sslData, detailedData)}
                ${generateCertificateChainSection(sslData, detailedData)}
                ${generateDetailedCipherSuitesSection(cipherSuiteData)}
                ${generateSSLTestsSection(detailedData)}
                ${generateSecurityVulnerabilitiesSection(detailedData)}
                ${generateSSLRecommendationsSection(sslData, detailedData, cipherSuiteData)}
            </div>
        </div>
    `;
    
    return sslHTML;
}

function generateBasicCertificateInfo(sslData, detailedData) {
    const cert = detailedData.certificateInfo?.certificateDeployments?.[0]?.receivedCertificateChain?.[0] || sslData;
    
    return `
        <div class="ssl-details">
            <div class="ssl-card">
                <h4>üìã Certificate Information</h4>
                <div class="status-item ${sslData.valid ? 'status-pass' : 'status-fail'}">
                    <span class="status-icon">${sslData.valid ? '‚úÖ' : '‚ùå'}</span>
                    <span>Certificate Status: ${sslData.valid ? 'Valid' : 'Invalid'}</span>
                </div>
                <p><strong>Subject:</strong> ${cert?.subject || sslData.subject || 'Unknown'}</p>
                <p><strong>Issuer:</strong> ${cert?.issuer || sslData.issuer || 'Unknown'}</p>
                <p><strong>Serial Number:</strong> ${cert?.serial_number || sslData.serialNumber || 'Unknown'}</p>
                <p><strong>Signature Algorithm:</strong> ${cert?.signature_algorithm_oid?.name || sslData.signatureAlgorithm || 'Unknown'}</p>
                ${sslData.grade ? `<p><strong>Overall Grade:</strong> <span class="grade-${sslData.grade?.toLowerCase()}">${sslData.grade}</span></p>` : ''}
            </div>
            
            <div class="ssl-card">
                <h4>üìÖ Validity Period</h4>
                ${cert?.not_valid_before || sslData.validFrom ? `
                    <p><strong>Valid From:</strong> ${new Date(cert?.not_valid_before || sslData.validFrom).toLocaleDateString()}</p>
                ` : ''}
                ${cert?.not_valid_after || sslData.validTo ? `
                    <p><strong>Valid To:</strong> ${new Date(cert?.not_valid_after || sslData.validTo).toLocaleDateString()}</p>
                ` : ''}
                ${sslData.daysUntilExpiry !== undefined ? `
                    <p><strong>Days Until Expiry:</strong> <span class="${sslData.daysUntilExpiry < 30 ? 'status-fail' : sslData.daysUntilExpiry < 90 ? 'status-warning' : 'status-pass'}">${sslData.daysUntilExpiry}</span></p>
                ` : ''}
            </div>
            
            <div class="ssl-card">
                <h4>üîë Key Information</h4>
                ${cert?.public_key ? `
                    <p><strong>Algorithm:</strong> ${cert.public_key.algorithm || 'Unknown'}</p>
                    <p><strong>Key Size:</strong> ${cert.public_key.key_size || 'Unknown'} bits</p>
                ` : `
                    <p><strong>Key Length:</strong> ${sslData.keyLength || 'Unknown'} bits</p>
                    <p><strong>Protocol:</strong> ${sslData.protocol || 'Unknown'}</p>
                `}
                ${cert?.signature_hash_algorithm?.name ? `
                    <p><strong>Hash Algorithm:</strong> ${cert.signature_hash_algorithm.name}</p>
                ` : ''}
            </div>
        </div>
        
        ${sslData.error ? `
        <div class="status-item status-fail">
            <span class="status-icon">‚ö†Ô∏è</span>
            <span>Error: ${sslData.error}</span>
        </div>
        ` : ''}
    `;
}

function generateHeadersSection(results) {
    if (!results.headers || results.headers.length === 0) return '';
    
    // Group headers by category
    const categories = {};
    results.headers.forEach(header => {
        const category = header.category || 'other';
        if (!categories[category]) categories[category] = [];
        categories[category].push(header);
    });
    
    let headersHTML = `
        <div class="section">
            <div class="section-header">
                üõ°Ô∏è Security Headers Analysis
            </div>
            <div class="section-content">
                <div class="headers-grid">
    `;
    
    Object.entries(categories).forEach(([category, headers]) => {
        const presentCount = headers.filter(h => h.present).length;
        const totalCount = headers.length;
        const percentage = Math.round((presentCount / totalCount) * 100);
        
        let progressClass = 'progress-danger';
        if (percentage >= 80) progressClass = 'progress-fill';
        else if (percentage >= 50) progressClass = 'progress-warning';
        
        headersHTML += `
            <div class="header-category">
                <div class="category-title">
                    ${category.charAt(0).toUpperCase() + category.slice(1)} Headers
                    <span class="category-stats">${presentCount}/${totalCount}</span>
                </div>
                <div class="progress-bar">
                    <div class="${progressClass}" style="width: ${percentage}%"></div>
                </div>
                <div class="header-list">
        `;
        
        headers.forEach(header => {
            headersHTML += `
                <div class="header-item">
                    <span>${header.name}</span>
                    <span style="color: ${header.present ? '#28a745' : '#dc3545'};">
                        ${header.present ? '‚úÖ' : '‚ùå'}
                    </span>
                </div>
            `;
        });
        
        headersHTML += `
                </div>
            </div>
        `;
    });
    
    headersHTML += `
                </div>
            </div>
        </div>
    `;
    
    return headersHTML;
}

function generateSecurityChecksSection(results) {
    if (!results.additional || results.additional.length === 0) return '';
    
    let checksHTML = `
        <div class="section">
            <div class="section-header">
                üîç Additional Security Checks
            </div>
            <div class="section-content">
    `;
    
    results.additional.forEach(check => {
        let statusClass = 'status-item';
        let icon = '‚ÑπÔ∏è';
        
        switch (check.status) {
            case 'pass':
                statusClass += ' status-pass';
                icon = '‚úÖ';
                break;
            case 'fail':
                statusClass += ' status-fail';
                icon = '‚ùå';
                break;
            case 'warning':
                statusClass += ' status-warning';
                icon = '‚ö†Ô∏è';
                break;
        }
        
        checksHTML += `
            <div class="${statusClass}">
                <span class="status-icon">${icon}</span>
                <div>
                    <strong>${check.name}</strong>
                    ${check.description ? `<p style="margin: 5px 0 0 0; font-size: 0.9em;">${check.description}</p>` : ''}
                    ${check.details ? `<p style="margin: 5px 0 0 0; font-size: 0.8em; opacity: 0.8;">${check.details}</p>` : ''}
                </div>
            </div>
        `;
    });
    
    checksHTML += `
            </div>
        </div>
    `;
    
    return checksHTML;
}

function generateRecommendationsSection(results) {
    if (!results.recommendations || results.recommendations.length === 0) return '';
    
    const priorities = {
        high: { title: 'High Priority', icon: 'üö®', class: 'recommendation-high' },
        medium: { title: 'Medium Priority', icon: '‚ö†Ô∏è', class: 'recommendation-medium' },
        low: { title: 'Low Priority', icon: '‚ÑπÔ∏è', class: 'recommendation-low' }
    };
    
    let recHTML = `
        <div class="section">
            <div class="section-header">
                üí° Security Recommendations
            </div>
            <div class="section-content">
    `;
    
    Object.entries(priorities).forEach(([priority, config]) => {
        const items = results.recommendations.filter(r => r.priority === priority);
        if (items.length === 0) return;
        
        recHTML += `<h4>${config.icon} ${config.title}</h4>`;
        
        items.forEach((rec, index) => {
            recHTML += `
                <div class="recommendation-box ${config.class}">
                    <strong>${index + 1}. ${rec.issue}</strong>
                    ${rec.recommendation ? `<p style="margin: 8px 0 0 0;">üí° ${rec.recommendation}</p>` : ''}
                    ${rec.impact ? `<p style="margin: 5px 0 0 0; font-size: 0.9em;">Impact: ${rec.impact}</p>` : ''}
                </div>
            `;
        });
    });
    
    recHTML += `
            </div>
        </div>
    `;
    
    return recHTML;
}

/**
 * Generate comprehensive HTML content for the PDF report with all details
 * @param {Object} results - Analysis results
 * @returns {string} HTML content
 */
function generateComprehensiveReportHTML(results) {
    const formatDate = (date) => new Date(date).toLocaleString();
    const formatScore = (score) => `${score || 0}`;
    
    return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCheck Security Analysis Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: white;
            font-size: 12px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .summary-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .summary-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }
        
        .section {
            margin: 30px 0;
            break-inside: avoid;
        }
        
        .section-header {
            background: #34495e;
            color: white;
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .section-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            border: 1px solid #e9ecef;
        }
        
        .ssl-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .ssl-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .ssl-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .header-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 11px;
        }
        
        .header-table th, .header-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .header-table th {
            background: #e9ecef;
            font-weight: 600;
            color: #495057;
        }
        
        .header-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .status-pass {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-fail {
            color: #dc3545;
            font-weight: bold;
        }
        
        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .check-item {
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .check-item:last-child {
            border-bottom: none;
        }
        
        .check-name {
            font-weight: 600;
            color: #495057;
        }
        
        .check-description {
            color: #6c757d;
            font-size: 0.95em;
            margin-top: 5px;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            color: #6c757d;
            border-top: 2px solid #e9ecef;
            padding-top: 20px;
            font-size: 0.9em;
        }
        
        .grade-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            font-size: 1.1em;
        }
        
        .grade-a { background: #28a745; }
        .grade-b { background: #17a2b8; }
        .grade-c { background: #ffc107; color: #212529; }
        .grade-d { background: #fd7e14; }
        .grade-f { background: #dc3545; }
        
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #e9ecef;
            font-family: 'Courier New', Consolas, monospace;
        }
        
        @media print {
            body { font-size: 10px; }
            .section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üõ°Ô∏è WebCheck Security Analysis Report</h1>
            <p>Comprehensive Security Assessment</p>
        </div>
        
        <!-- Summary -->
        <div class="summary-grid">
            <div class="summary-card">
                <h3>üìä Overall Score</h3>
                <div class="value">${formatScore(results.score)}/100</div>
            </div>
            <div class="summary-card">
                <h3>üåê Target URL</h3>
                <div style="font-size: 1.2em; color: #495057; word-break: break-all;">${results.url || 'N/A'}</div>
            </div>
            <div class="summary-card">
                <h3>üìÖ Analysis Date</h3>
                <div style="font-size: 1.2em; color: #495057;">${formatDate(new Date())}</div>
            </div>
        </div>
        
        ${generateSSLSection(results.details?.ssl || results.ssl, results.details?.detailedSsl || results.detailedSsl, results.details?.ssl?.tests || results.tests)}
        ${generateHeadersSection(results.details?.headers || results.headers)}
        ${generateAdditionalChecksSection(results.details?.additional || results.additional)}
        
        <!-- Footer -->
        <div class="footer">
            <p><strong>Generated by WebCheck Validator</strong></p>
            <p>Professional Security Analysis Tool ‚Ä¢ ${formatDate(new Date())}</p>
            <p>Visit our GitHub repository for more information and updates</p>
        </div>
    </div>
</body>
</html>`;
}

/**
 * Generate SSL/TLS section for PDF
 */
function generateSSLSection(ssl, detailedSsl, tests) {
    if (!ssl && !detailedSsl) return '';
    
    const sslData = ssl || {};
    const detailedData = detailedSsl || {};
    
    // Debug logging for certificate chain
    console.log('üîç PDF Generator - SSL Data Structure:');
    console.log('sslData.chain:', sslData.chain?.length || 'undefined');
    console.log('sslData.certificateChain:', sslData.certificateChain?.length || 'undefined');
    console.log('detailedData.chain:', detailedData.chain?.length || 'undefined');
    console.log('detailedData.certificateChain:', detailedData.certificateChain?.length || 'undefined');
    
    const getGradeClass = (grade) => {
        if (!grade) return 'grade-f';
        const g = grade.toLowerCase();
        if (g.includes('a')) return 'grade-a';
        if (g.includes('b')) return 'grade-b';
        if (g.includes('c')) return 'grade-c';
        if (g.includes('d')) return 'grade-d';
        return 'grade-f';
    };
    
    // Use the tests array passed as parameter
    const testsArray = tests && Array.isArray(tests) ? tests : [];
    
    return `
        <div class="section">
            <div class="section-header">
                üîí SSL/TLS Certificate Analysis
            </div>
            <div class="section-content">
                <div class="ssl-details">
                    <div class="ssl-card">
                        <h4>Certificate Status</h4>
                        <p><strong>Valid:</strong> <span class="${sslData.valid ? 'status-pass' : 'status-fail'}">${sslData.valid ? 'Yes' : 'No'}</span></p>
                        ${sslData.grade ? `<p><strong>Grade:</strong> <span class="grade-badge ${getGradeClass(sslData.grade)}">${sslData.grade}</span></p>` : ''}
                        ${sslData.score !== undefined ? `<p><strong>Score:</strong> ${sslData.score}/100</p>` : ''}
                    </div>
                    
                    ${sslData.issuer ? `
                    <div class="ssl-card">
                        <h4>Certificate Authority</h4>
                        <p><strong>Issuer:</strong> ${sslData.issuer}</p>
                        ${sslData.subject ? `<p><strong>Subject:</strong> ${sslData.subject}</p>` : ''}
                    </div>
                    ` : ''}
                    
                    ${sslData.validFrom || sslData.validTo ? `
                    <div class="ssl-card">
                        <h4>Validity Period</h4>
                        ${sslData.validFrom ? `<p><strong>Valid From:</strong> ${new Date(sslData.validFrom).toLocaleDateString()}</p>` : ''}
                        ${sslData.validTo ? `<p><strong>Valid To:</strong> ${new Date(sslData.validTo).toLocaleDateString()}</p>` : ''}
                        ${sslData.daysUntilExpiry !== undefined ? `<p><strong>Days Until Expiry:</strong> ${sslData.daysUntilExpiry}</p>` : ''}
                    </div>
                    ` : ''}
                    
                    ${detailedData.keyAlgorithm || detailedData.keySize ? `
                    <div class="ssl-card">
                        <h4>Key Information</h4>
                        ${detailedData.keyAlgorithm ? `<p><strong>Algorithm:</strong> ${detailedData.keyAlgorithm}</p>` : ''}
                        ${detailedData.keySize ? `<p><strong>Key Size:</strong> ${detailedData.keySize} bits</p>` : ''}
                        ${detailedData.signatureAlgorithm ? `<p><strong>Signature:</strong> ${detailedData.signatureAlgorithm}</p>` : ''}
                    </div>
                    ` : ''}
                </div>
                
                ${(sslData.chain && sslData.chain.length > 0) || (sslData.certificateChain && sslData.certificateChain.length > 0) || (detailedData.chain && detailedData.chain.length > 0) || (detailedData.certificateChain && detailedData.certificateChain.length > 0) ? `
                <h4 style="margin-top: 20px; margin-bottom: 15px;">üîó Certificate Chain</h4>
                <div class="ssl-details">
                    ${(sslData.chain || sslData.certificateChain || detailedData.chain || detailedData.certificateChain || []).map((cert, index) => {
                        const chainArray = sslData.chain || sslData.certificateChain || detailedData.chain || detailedData.certificateChain || [];
                        return `
                        <div class="ssl-card">
                            <h4>${index === 0 ? 'üéØ End Entity Certificate' : index === chainArray.length - 1 ? 'üèõÔ∏è Root Certificate' : 'üîó Intermediate Certificate'} ${index + 1}</h4>
                            <p><strong>Subject:</strong> ${cert.subject || 'Unknown'}</p>
                            <p><strong>Issuer:</strong> ${cert.issuer || 'Unknown'}</p>
                            ${cert.validFrom ? `<p><strong>Valid From:</strong> ${new Date(cert.validFrom).toLocaleDateString()}</p>` : ''}
                            ${cert.validTo ? `<p><strong>Valid To:</strong> ${new Date(cert.validTo).toLocaleDateString()}</p>` : ''}
                            ${cert.keyAlgorithm ? `<p><strong>Key Algorithm:</strong> ${cert.keyAlgorithm}</p>` : ''}
                            ${cert.keySize ? `<p><strong>Key Size:</strong> ${cert.keySize} bits</p>` : ''}
                            ${cert.signatureAlgorithm ? `<p><strong>Signature Algorithm:</strong> ${cert.signatureAlgorithm}</p>` : ''}
                            ${cert.serialNumber ? `<p><strong>Serial Number:</strong> ${cert.serialNumber}</p>` : ''}
                            ${cert.fingerprint ? `<p><strong>Fingerprint (SHA1):</strong> <code style="font-size: 0.8em; word-break: break-all;">${cert.fingerprint}</code></p>` : ''}
                        </div>
                    `}).join('')}
                </div>
                ` : ''}
                
                ${generateCipherSuitesSection(sslData, detailedData)}
                
                ${testsArray.length > 0 ? `
                <h4 style="margin-top: 20px; margin-bottom: 15px;">üß™ Detailed SSL Tests</h4>
                <table class="header-table">
                    <thead>
                        <tr>
                            <th>Test</th>
                            <th>Status</th>
                            <th>Description</th>
                            <th>Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${testsArray.map(test => `
                            <tr>
                                <td>${test.name || 'Unknown Test'}</td>
                                <td><span class="${test.status === 'pass' ? 'status-pass' : test.status === 'fail' ? 'status-fail' : 'status-warning'}">${(test.status || 'unknown').toUpperCase()}</span></td>
                                <td>${test.description || 'N/A'}</td>
                                <td>${(test.status === 'pass') ? '' : (test.recommendation || '')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ` : ''}
            </div>
        </div>
    `;
}

/**
 * Generate cipher suites section for SSL analysis
 * @param {Object} sslData - SSL data
 * @param {Object} detailedData - Detailed SSL data
 * @returns {string} Cipher suites HTML section
 */
function generateCipherSuitesSection(sslData, detailedData) {
    // Check for cipher suite data in the correct locations
    const cipherSuiteData = sslData?.cipherSuites || detailedData?.cipherSuites;
    
    console.log('üîç PDF Generator - Cipher Suite Data Check:');
    console.log('sslData keys:', sslData ? Object.keys(sslData) : 'null');
    console.log('detailedData keys:', detailedData ? Object.keys(detailedData) : 'null');
    console.log('sslData.cipherSuites:', !!sslData?.cipherSuites);
    console.log('detailedData.cipherSuites:', !!detailedData?.cipherSuites);
    
    // Also check for cipher suite data in combinedResults (where it might actually be)
    const combinedCipherSuites = detailedData?.combinedResults?.cipherSuites;
    console.log('detailedData.combinedResults.cipherSuites:', !!combinedCipherSuites);
    
    const finalCipherData = cipherSuiteData || combinedCipherSuites;
    
    if (!finalCipherData || !finalCipherData.details) {
        console.log('‚ùå No cipher suite data found in PDF generator');
        return ''; // No cipher suite data available
    }
    
    const details = finalCipherData.details;
    const analysis = finalCipherData.analysis || {};
    
    console.log('‚úÖ Found cipher suite data:', Object.keys(details));
    
    // Convert the TLS version data to the format expected by the template
    const tlsVersionData = [];
    
    // Process each TLS version from the cipher suite details
    Object.keys(details).forEach(version => {
        const versionData = details[version];
        if (versionData && versionData.cipherSuiteDetails && versionData.cipherSuiteDetails.length > 0) {
            tlsVersionData.push({
                version: version.replace('tls', 'TLS ').replace('_', '.').replace('Support', ''),
                suites: versionData.cipherSuiteDetails,
                analysis: versionData.securityAnalysis || {},
                supported: versionData.supported
            });
        }
    });
    
    if (tlsVersionData.length === 0) {
        console.log('‚ùå No valid TLS version data found');
        return ''; // No valid cipher suite data
    }
    
    return `
        <h4 style="margin-top: 20px; margin-bottom: 15px;">üîí Cipher Suite Analysis</h4>
        
        <!-- Overall Analysis Summary -->
        ${analysis && Object.keys(analysis).length > 0 ? `
        <div class="ssl-details">
            <div class="ssl-card">
                <h6>Overall Security Analysis</h6>
                <p><strong>Total Cipher Suites:</strong> ${analysis.totalSuites || 0}</p>
                <p><strong>Secure Suites:</strong> <span class="status-pass">${analysis.secureSuites || 0}</span></p>
                <p><strong>Weak Suites:</strong> <span class="status-warning">${analysis.weakSuites || 0}</span></p>
                <p><strong>Insecure Suites:</strong> <span class="status-fail">${analysis.insecureSuites || 0}</span></p>
                <p><strong>Forward Secrecy Support:</strong> <span class="${analysis.hasForwardSecrecy ? 'status-pass' : 'status-warning'}">${analysis.hasForwardSecrecy ? '‚úÖ Yes' : '‚ö†Ô∏è Limited'}</span></p>
                <p><strong>Overall Security Level:</strong> <span class="grade-${analysis.overallSecurity?.toLowerCase()}">${analysis.overallSecurity || 'Unknown'}</span></p>
            </div>
        </div>
        ` : ''}
        
        ${tlsVersionData.map(tlsVersion => `
            <div style="margin-bottom: 20px;">
                <h5 style="color: #495057; margin-bottom: 10px;">${tlsVersion.version} Cipher Suites</h5>
                
                ${tlsVersion.analysis ? `
                <div class="ssl-details">
                    <div class="ssl-card">
                        <h6>Security Summary</h6>
                        <p><strong>Total Suites:</strong> ${tlsVersion.analysis.secureSuites + tlsVersion.analysis.weakSuites + tlsVersion.analysis.insecureSuites}</p>
                        <p><strong>Secure:</strong> <span class="status-pass">${tlsVersion.analysis.secureSuites}</span></p>
                        <p><strong>Weak:</strong> <span class="status-warning">${tlsVersion.analysis.weakSuites}</span></p>
                        <p><strong>Insecure:</strong> <span class="status-fail">${tlsVersion.analysis.insecureSuites}</span></p>
                        <p><strong>Forward Secrecy:</strong> ${tlsVersion.analysis.forwardSecrecySuites}</p>
                    </div>
                </div>
                ` : ''}
                
                ${tlsVersion.suites && tlsVersion.suites.length > 0 ? `
                <table class="header-table" style="margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>Cipher Suite</th>
                            <th>Security Level</th>
                            <th>Key Exchange</th>
                            <th>Encryption</th>
                            <th>Forward Secrecy</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tlsVersion.suites.slice(0, 10).map(suite => `
                            <tr>
                                <td style="font-family: monospace; font-size: 0.8em;">${suite.name || 'Unknown'}</td>
                                <td><span class="${suite.securityLevel === 'secure' ? 'status-pass' : suite.securityLevel === 'weak' ? 'status-warning' : 'status-fail'}">${(suite.securityLevel || 'unknown').toUpperCase()}</span></td>
                                <td>${suite.keyExchange || 'Unknown'}</td>
                                <td>${suite.encryption ? `${suite.encryption.algorithm} ${suite.encryption.keySize}` : 'Unknown'}</td>
                                <td>${suite.forwardSecrecy ? '‚úÖ Yes' : '‚ùå No'}</td>
                            </tr>
                        `).join('')}
                        ${tlsVersion.suites.length > 10 ? `
                            <tr>
                                <td colspan="5" style="text-align: center; font-style: italic; color: #6c757d;">
                                    ... and ${tlsVersion.suites.length - 10} more cipher suites
                                </td>
                            </tr>
                        ` : ''}
                    </tbody>
                </table>
                ` : ''}
                
                ${tlsVersion.analysis && tlsVersion.analysis.recommendations && tlsVersion.analysis.recommendations.length > 0 ? `
                <div style="margin-top: 10px;">
                    <h6 style="color: #dc3545;">Recommendations:</h6>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        ${tlsVersion.analysis.recommendations.map(rec => `
                            <li style="margin: 2px 0; font-size: 0.9em;">${rec.action || rec}</li>
                        `).join('')}
                    </ul>
                </div>
                ` : ''}
            </div>
        `).join('')}
    `;
}

/**
 * Generate Security Headers section for PDF
 */
function generateHeadersSection(headers) {
    if (!headers || !Array.isArray(headers)) return '';
    
    const presentHeaders = headers.filter(h => h.present);
    const missingHeaders = headers.filter(h => !h.present);
    
    return `
        <div class="section">
            <div class="section-header">
                üõ°Ô∏è Security Headers Analysis
            </div>
            <div class="section-content">
                <div class="ssl-details">
                    <div class="ssl-card">
                        <h4>Summary</h4>
                        <p><strong>Total Headers:</strong> ${headers.length}</p>
                        <p><strong>Present:</strong> <span class="status-pass">${presentHeaders.length}</span></p>
                        <p><strong>Missing:</strong> <span class="status-fail">${missingHeaders.length}</span></p>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 15px;">üìã Header Details</h4>
                <table class="header-table">
                    <thead>
                        <tr>
                            <th>Header</th>
                            <th>Status</th>
                            <th>Value</th>
                            <th>Category</th>
                            <th>Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${headers.map(header => {
                            // Handle information headers differently (Hidden vs Missing, Disclosed vs Present)
                            let statusText, statusClass, recommendation;
                            if (header.category === 'information') {
                                // For information headers, absence is good
                                statusText = header.present ? 'Disclosed' : 'Hidden';
                                statusClass = header.present ? 'status-fail' : 'status-pass';
                                // Only recommend action when information is disclosed (bad)
                                recommendation = header.present ? (header.recommendation || 'Hide server information header') : '';
                            } else {
                                statusText = header.present ? 'Present' : 'Missing';
                                statusClass = header.present ? 'status-pass' : 'status-fail';
                                // Only recommend action when header is missing (bad)
                                recommendation = header.present ? '' : (header.recommendation || 'Implement this security header');
                            }
                            
                            return `
                                <tr>
                                    <td><strong>${header.name || 'Unknown'}</strong></td>
                                    <td><span class="${statusClass}">${statusText}</span></td>
                                    <td style="max-width: 200px; word-break: break-all;">${header.value || 'N/A'}</td>
                                    <td>${header.category || 'Unknown'}</td>
                                    <td>${recommendation}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

/**
 * Generate Additional Security Checks section for PDF
 */
function generateAdditionalChecksSection(additional) {
    if (!additional || !Array.isArray(additional)) return '';
    
    const passedChecks = additional.filter(c => c.status === 'pass');
    const failedChecks = additional.filter(c => c.status === 'fail');
    const warningChecks = additional.filter(c => c.status === 'warning');
    
    return `
        <div class="section">
            <div class="section-header">
                üîç Additional Security Checks
            </div>
            <div class="section-content">
                <div class="ssl-details">
                    <div class="ssl-card">
                        <h4>Summary</h4>
                        <p><strong>Total Checks:</strong> ${additional.length}</p>
                        <p><strong>Passed:</strong> <span class="status-pass">${passedChecks.length}</span></p>
                        <p><strong>Failed:</strong> <span class="status-fail">${failedChecks.length}</span></p>
                        <p><strong>Warnings:</strong> <span class="status-warning">${warningChecks.length}</span></p>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 15px;">‚úÖ Check Results</h4>
                ${additional.map(check => `
                    <div class="check-item">
                        <div class="check-name">
                            ${check.name || 'Unknown Check'} - 
                            <span class="${check.status === 'pass' ? 'status-pass' : check.status === 'fail' ? 'status-fail' : 'status-warning'}">
                                ${(check.status || 'unknown').toUpperCase()}
                            </span>
                        </div>
                        ${check.description ? `<div class="check-description">${check.description}</div>` : ''}
                        ${check.details ? `<div class="check-description"><strong>Details:</strong> ${check.details}</div>` : ''}
                        ${(check.status !== 'pass' && check.recommendation) ? `<div class="check-description"><strong>Recommendation:</strong> ${check.recommendation}</div>` : ''}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

/**
 * Generate comprehensive cipher suites section with detailed analysis
 * @param {Object} cipherSuiteData - Cipher suite analysis data
 * @returns {string} Detailed cipher suites HTML section
 */
function generateDetailedCipherSuitesSection(cipherSuiteData) {
    // Check if we have any cipher suite data
    if (!cipherSuiteData) return '';
    
    const analysis = cipherSuiteData.analysis || {};
    const details = cipherSuiteData.details || {};
    
    // If we don't have analysis or details, try to check if details has TLS versions
    const hasData = Object.keys(analysis).length > 0 || Object.keys(details).length > 0;
    if (!hasData) return '';
    
    return `
        <h4 style="margin-top: 25px; margin-bottom: 15px;">üîí Comprehensive Cipher Suite Analysis</h4>
        
        <!-- Overall Security Summary -->
        ${Object.keys(analysis).length > 0 ? `
        <div class="ssl-details">
            <div class="ssl-card">
                <h4>üìä Security Overview</h4>
                <p><strong>Total Cipher Suites:</strong> ${analysis.totalSuites || 0}</p>
                <p><strong>Secure Suites:</strong> <span class="status-pass">${analysis.secureSuites || 0}</span></p>
                <p><strong>Weak Suites:</strong> <span class="status-warning">${analysis.weakSuites || 0}</span></p>
                <p><strong>Insecure Suites:</strong> <span class="status-fail">${analysis.insecureSuites || 0}</span></p>
                <p><strong>Forward Secrecy Support:</strong> <span class="${analysis.hasForwardSecrecy ? 'status-pass' : 'status-warning'}">${analysis.hasForwardSecrecy ? '‚úÖ Yes' : '‚ö†Ô∏è Limited'}</span></p>
                <p><strong>Overall Security Level:</strong> <span class="grade-${analysis.overallSecurity?.toLowerCase()}">${analysis.overallSecurity || 'Unknown'}</span></p>
            </div>
        </div>
        ` : ''}
        
        <!-- TLS Version Analysis -->
        ${generateTLSVersionAnalysis(details)}
        
        <!-- Security Recommendations -->
        ${analysis.recommendations && analysis.recommendations.length > 0 ? `
        <div style="margin-top: 20px;">
            <h4>üí° Cipher Suite Recommendations</h4>
            <div class="ssl-card">
                <ul style="margin: 10px 0; padding-left: 20px;">
                    ${analysis.recommendations.map(rec => `
                        <li style="margin: 5px 0; color: ${rec.priority === 'high' ? '#dc3545' : rec.priority === 'medium' ? '#fd7e14' : '#6c757d'};">
                            <strong>[${rec.priority?.toUpperCase()}]</strong> ${rec.action || rec}
                            ${rec.issue ? `<br><small style="color: #6c757d;">${rec.issue}</small>` : ''}
                        </li>
                    `).join('')}
                </ul>
            </div>
        </div>
        ` : ''}
    `;
}

function generateTLSVersionAnalysis(details) {
    const tlsVersions = [
        { key: 'tls1_3Support', name: 'TLS 1.3', modern: true },
        { key: 'tls1_2Support', name: 'TLS 1.2', modern: true },
        { key: 'tls1_1Support', name: 'TLS 1.1', modern: false },
        { key: 'tls1_0Support', name: 'TLS 1.0', modern: false }
    ];
    
    let html = '';
    
    tlsVersions.forEach(version => {
        const versionData = details[version.key];
        if (versionData && versionData.cipherSuiteDetails && versionData.cipherSuiteDetails.length > 0) {
            const secureCount = versionData.cipherSuiteDetails.filter(c => c.securityLevel === 'secure').length;
            const weakCount = versionData.cipherSuiteDetails.filter(c => c.securityLevel === 'weak').length;
            const insecureCount = versionData.cipherSuiteDetails.filter(c => c.securityLevel === 'insecure').length;
            
            html += `
                <div style="margin: 20px 0;">
                    <h5 style="color: ${version.modern ? '#28a745' : '#dc3545'}; margin-bottom: 10px;">
                        ${version.modern ? '‚úÖ' : '‚ö†Ô∏è'} ${version.name} Cipher Suites (${versionData.cipherSuiteDetails.length} total)
                    </h5>
                    
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong>Security Breakdown:</strong>
                        <span style="margin-left: 10px; color: #28a745;">Secure: ${secureCount}</span>
                        <span style="margin-left: 10px; color: #fd7e14;">Weak: ${weakCount}</span>
                        <span style="margin-left: 10px; color: #dc3545;">Insecure: ${insecureCount}</span>
                    </div>
                    
                    <!-- Top Cipher Suites Table -->
                    <table class="header-table" style="font-size: 0.85em;">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Cipher Suite</th>
                                <th style="width: 15%;">Security</th>
                                <th style="width: 15%;">Key Exchange</th>
                                <th style="width: 20%;">Encryption</th>
                                <th style="width: 15%;">Forward Secrecy</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${versionData.cipherSuiteDetails.slice(0, 8).map(suite => `
                                <tr>
                                    <td style="font-family: 'Courier New', monospace; font-size: 0.75em; word-break: break-all;">${suite.name || 'Unknown'}</td>
                                    <td>
                                        <span class="${
                                            suite.securityLevel === 'secure' ? 'status-pass' : 
                                            suite.securityLevel === 'weak' ? 'status-warning' : 
                                            'status-fail'
                                        }">
                                            ${suite.securityLevel === 'secure' ? '‚úÖ' : suite.securityLevel === 'weak' ? '‚ö†Ô∏è' : '‚ùå'} 
                                            ${(suite.securityLevel || 'unknown').toUpperCase()}
                                        </span>
                                    </td>
                                    <td>${suite.keyExchange || 'Unknown'}</td>
                                    <td>${suite.encryption ? `${suite.encryption.algorithm}-${suite.encryption.keySize}` : 'Unknown'}</td>
                                    <td>${suite.forwardSecrecy ? 'üîí Yes' : 'üîì No'}</td>
                                </tr>
                            `).join('')}
                            ${versionData.cipherSuiteDetails.length > 8 ? `
                                <tr>
                                    <td colspan="5" style="text-align: center; font-style: italic; color: #6c757d; padding: 10px;">
                                        ... and ${versionData.cipherSuiteDetails.length - 8} more cipher suites
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            `;
        }
    });
    
    return html;
}

function generateCertificateChainSection(sslData, detailedData) {
    // Try multiple sources for certificate chain data
    const chainData = detailedData.certificateInfo?.certificateDeployments?.[0]?.receivedCertificateChain || 
                     sslData.chain || 
                     sslData.certificateChain || 
                     [];
                     
    if (!chainData || chainData.length === 0) return '';
    
    return `
        <h4 style="margin-top: 25px; margin-bottom: 15px;">üîó Certificate Chain Analysis</h4>
        <div class="ssl-details">
            ${chainData.map((cert, index) => `
                <div class="ssl-card">
                    <h4>${index === 0 ? 'üéØ End Entity Certificate' : index === chainData.length - 1 ? 'üèõÔ∏è Root Certificate' : 'üîó Intermediate Certificate'} ${index + 1}</h4>
                    <p><strong>Subject:</strong> ${cert.subject?.rfc4514_string || cert.subject || 'Unknown'}</p>
                    <p><strong>Issuer:</strong> ${cert.issuer?.rfc4514_string || cert.issuer || 'Unknown'}</p>
                    ${cert.not_valid_before || cert.validFrom ? `<p><strong>Valid From:</strong> ${new Date(cert.not_valid_before || cert.validFrom).toLocaleDateString()}</p>` : ''}
                    ${cert.not_valid_after || cert.validTo ? `<p><strong>Valid To:</strong> ${new Date(cert.not_valid_after || cert.validTo).toLocaleDateString()}</p>` : ''}
                    ${cert.public_key ? `
                        <p><strong>Key Algorithm:</strong> ${cert.public_key.algorithm}</p>
                        <p><strong>Key Size:</strong> ${cert.public_key.key_size} bits</p>
                    ` : ''}
                    ${cert.signature_algorithm_oid?.name ? `<p><strong>Signature Algorithm:</strong> ${cert.signature_algorithm_oid.name}</p>` : ''}
                    ${cert.serial_number ? `<p><strong>Serial Number:</strong> ${cert.serial_number}</p>` : ''}
                    ${cert.fingerprint_sha256 ? `<p><strong>SHA256 Fingerprint:</strong> <code style="font-size: 0.7em; word-break: break-all;">${cert.fingerprint_sha256}</code></p>` : ''}
                </div>
            `).join('')}
        </div>
    `;
}

function generateSSLTestsSection(detailedData) {
    const tests = [];
    
    // SSL/TLS Protocol Tests
    if (detailedData.ssl2Support) tests.push({ name: 'SSL 2.0', status: detailedData.ssl2Support.passed ? 'fail' : 'pass', description: 'SSL 2.0 Support (should be disabled)' });
    if (detailedData.ssl3Support) tests.push({ name: 'SSL 3.0', status: detailedData.ssl3Support.passed ? 'fail' : 'pass', description: 'SSL 3.0 Support (should be disabled)' });
    if (detailedData.tls1_0Support) tests.push({ name: 'TLS 1.0', status: detailedData.tls1_0Support.passed ? 'warning' : 'pass', description: 'TLS 1.0 Support (deprecated)' });
    if (detailedData.tls1_1Support) tests.push({ name: 'TLS 1.1', status: detailedData.tls1_1Support.passed ? 'warning' : 'pass', description: 'TLS 1.1 Support (deprecated)' });
    if (detailedData.tls1_2Support) tests.push({ name: 'TLS 1.2', status: detailedData.tls1_2Support.passed ? 'pass' : 'fail', description: 'TLS 1.2 Support (recommended)' });
    if (detailedData.tls1_3Support) tests.push({ name: 'TLS 1.3', status: detailedData.tls1_3Support.passed ? 'pass' : 'warning', description: 'TLS 1.3 Support (modern)' });
    
    // Vulnerability Tests
    if (detailedData.heartbleed) tests.push({ name: 'Heartbleed', status: detailedData.heartbleed.vulnerable ? 'fail' : 'pass', description: 'CVE-2014-0160 Heartbleed vulnerability' });
    if (detailedData.robot) tests.push({ name: 'ROBOT', status: detailedData.robot.vulnerable ? 'fail' : 'pass', description: 'ROBOT attack vulnerability' });
    if (detailedData.ccsInjection) tests.push({ name: 'CCS Injection', status: detailedData.ccsInjection.vulnerable ? 'fail' : 'pass', description: 'ChangeCipherSpec injection vulnerability' });
    
    if (tests.length === 0) return '';
    
    return `
        <h4 style="margin-top: 25px; margin-bottom: 15px;">üß™ SSL/TLS Security Tests</h4>
        <table class="header-table">
            <thead>
                <tr>
                    <th>Test</th>
                    <th>Status</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                ${tests.map(test => `
                    <tr>
                        <td>${test.name}</td>
                        <td><span class="${test.status === 'pass' ? 'status-pass' : test.status === 'fail' ? 'status-fail' : 'status-warning'}">${test.status.toUpperCase()}</span></td>
                        <td>${test.description}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function generateSecurityVulnerabilitiesSection(detailedData) {
    const vulnerabilities = [];
    
    if (detailedData.heartbleed?.vulnerable) vulnerabilities.push({ name: 'Heartbleed (CVE-2014-0160)', severity: 'high', description: 'Critical vulnerability allowing memory disclosure' });
    if (detailedData.robot?.vulnerable) vulnerabilities.push({ name: 'ROBOT Attack', severity: 'high', description: 'RSA decryption oracle vulnerability' });
    if (detailedData.ccsInjection?.vulnerable) vulnerabilities.push({ name: 'CCS Injection', severity: 'medium', description: 'ChangeCipherSpec injection vulnerability' });
    
    if (vulnerabilities.length === 0) return '';
    
    return `
        <h4 style="margin-top: 25px; margin-bottom: 15px;">‚ö†Ô∏è Security Vulnerabilities</h4>
        <div class="ssl-details">
            ${vulnerabilities.map(vuln => `
                <div class="ssl-card" style="border-left: 4px solid ${vuln.severity === 'high' ? '#dc3545' : '#fd7e14'};">
                    <h4 style="color: ${vuln.severity === 'high' ? '#dc3545' : '#fd7e14'};">${vuln.name}</h4>
                    <p><strong>Severity:</strong> <span class="${vuln.severity === 'high' ? 'status-fail' : 'status-warning'}">${vuln.severity.toUpperCase()}</span></p>
                    <p><strong>Description:</strong> ${vuln.description}</p>
                </div>
            `).join('')}
        </div>
    `;
}

function generateSSLRecommendationsSection(sslData, detailedData, cipherSuiteData) {
    const recommendations = [];
    
    // Certificate recommendations
    if (sslData.daysUntilExpiry < 30) recommendations.push({ priority: 'high', text: 'Certificate expires soon - renew immediately' });
    else if (sslData.daysUntilExpiry < 90) recommendations.push({ priority: 'medium', text: 'Certificate expires within 90 days - plan renewal' });
    
    // Protocol recommendations
    if (detailedData.ssl2Support?.passed) recommendations.push({ priority: 'high', text: 'Disable SSL 2.0 support immediately' });
    if (detailedData.ssl3Support?.passed) recommendations.push({ priority: 'high', text: 'Disable SSL 3.0 support immediately' });
    if (detailedData.tls1_0Support?.passed) recommendations.push({ priority: 'medium', text: 'Consider disabling TLS 1.0 for better security' });
    if (detailedData.tls1_1Support?.passed) recommendations.push({ priority: 'medium', text: 'Consider disabling TLS 1.1 for better security' });
    if (!detailedData.tls1_3Support?.passed) recommendations.push({ priority: 'medium', text: 'Enable TLS 1.3 support for improved security and performance' });
    
    // Cipher suite recommendations from analysis
    if (cipherSuiteData.analysis?.recommendations) {
        cipherSuiteData.analysis.recommendations.forEach(rec => {
            recommendations.push({ priority: rec.priority || 'medium', text: rec.action || rec });
        });
    }
    
    if (recommendations.length === 0) return '';
    
    return `
        <h4 style="margin-top: 25px; margin-bottom: 15px;">üí° SSL/TLS Security Recommendations</h4>
        <div class="ssl-details">
            <div class="ssl-card">
                <ul style="margin: 10px 0; padding-left: 20px;">
                    ${recommendations.map(rec => `
                        <li style="margin: 8px 0; color: ${rec.priority === 'high' ? '#dc3545' : rec.priority === 'medium' ? '#fd7e14' : '#6c757d'};">
                            <strong>[${rec.priority.toUpperCase()}]</strong> ${rec.text}
                        </li>
                    `).join('')}
                </ul>
            </div>
        </div>
    `;
}

module.exports = {
    generatePDFReport
};
